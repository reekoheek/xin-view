<link rel="import" href="../polymer/polymer.html">

<!--
`xin-view` is a unit that represent page or a single view.

Example:

    <xin-view uri="/">
      This is root view
    </xin-view>

    <xin-view uri="/foo">
      <h1>Foo</h1>
      <p>This is foo view</p>
    </xin-view>

    <xin-view uri="/bar">
      This is bar view
    </xin-view>

@demo
-->
<dom-module id="xin-view">
  <template>
    <content></content>
  </template>

  <style>
    :host {
      box-sizing: border-box;
      display: block;
    }

    :host(.view-hidden) {
      display: none!important;
    }
  </style>
</dom-module>

<script>
  (function() {
    'use strict';

    Polymer({
      is: 'xin-view',

      created: function() {
        var layout = this.getAttribute('layout'),
          layoutEl;
        if (layout) {
          layoutEl = document.getElementById(layout);
          if (layoutEl) {
            var content = document.createDocumentFragment();
            Polymer.dom(this.root).childNodes.forEach(function(node) {
              content.appendChild(node);
            });

            var t = document.importNode(layoutEl, true);
            Polymer.dom(this.root).appendChild(this.instanceTemplate(t));
            Polymer.dom(this.root).querySelectorAll('content').forEach(function(element) {
              if (element.select) {

                var rep = content.querySelector(element.select);
                if (rep) {
                  Polymer.dom(element.parentNode).insertBefore(rep, element);
                }
              } else {
                Polymer.dom(element.parentNode).insertBefore(content, element);
              }
            }.bind(this));
          }
        }
      },

      attached: function() {
        var classList = Polymer.dom(this).classList;
        classList.remove('view-focused');
        classList.add('view-hidden');

        this.$app = xin.dom(this).parent('xin-app');

        if (this.parentElement.add) {
          this.parentElement.add(this);
        }

        this.async(function() {
          this.$app.route(this.uri, this.focus.bind(this));
            this.fire('routed');
        });
      },

      properties: {
        /**
         * Attach this view to route with specified URI
         * @type {String}
         */
        uri: String,

        src: {
          type: String,
          observer: '_srcChanged'
        },
      },

      /**
       * Set view to be focused
       */
      focus: function() {
        if (this.parentElement.setFocus) {
          this.parentElement.setFocus(this);
        } else {
          var parent = Polymer.dom(this.parentElement);
          parent.children.forEach(function(element) {
            element.setFocus(false);
            element.setHidden(true);
          });

          this.setFocus(true);
          this.setHidden(false);
        }
      },

      setHidden: function(hidden) {
        var classList = Polymer.dom(this).classList;
        if (hidden) {
          classList.add('view-hidden');
          this.fire('hide');
        } else {
          classList.remove('view-hidden');
          this.fire('show');
        }
      },

      setFocus: function(focus) {
        var classList = Polymer.dom(this).classList;
        if (focus) {
          classList.add('view-focused');
          this.fire('focus');
        } else {
          classList.remove('view-focused');
          this.fire('blur');
        }
      },

      _srcChanged: function() {
        xin.import(this.src)
          .then(function($link) {
            var $body = Polymer.dom($link.import.body);
            $body.childNodes.forEach(function(node) {
              Polymer.dom(this).appendChild(node);
            }.bind(this));
          }.bind(this));
      }
    });

  })(this);
</script>